<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tính giai thừa</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/giaiThua.js"></script>
</head>
<body>
    <div>
        <button id="connect" style="display: block">Connect metamask</button>
        <div>
    
            <p id="account" style="display: none"></p>
            <p id="balanceVal"></p>
            <p id="balanceBNBVal"></p>
    
    
        </div>
    </div>
    <div>
        <form>
            <label for="message">Message:</label>
            <input type="text" id="message" name="message"><br><br>
            <label for="nonce">Nonce:</label>
            <input type="text" id="nonce" name="nonce"><br><br>
        </form>
        <button id="sign">Sign</button>
        <p id="msg"></p>
    </div>
    
    
    <div>
        <h4> Message: </h4>
        <p id="message_signed">
        <h4> Signature: </h4>
        <p id="signature"></p>
    </div>
    <input type="number" id="input-number"/>
    <button id="btn-check">Tính</button>
    <h1 id="show"></h1>
    
</body>
<script type="application/javascript">
    function show(){
        let x = document.getElementById("openBox");
        x.style.display = "block";
    }
    if (typeof window.ethereum !== 'undefined') {
        console.log('MetaMask is installed!');
    }

    async function connectMetamask() {
        if (typeof web3 !== 'undefined') {
            window.web3 = new Web3(web3.currentProvider);
        } else {
            console.log('No web3? You should consider trying MetaMask!');
            window.web3 = new Web3(new Web3.providers.HttpProvider('http://localhost:8545'));
        }
        if (window.ethereum) {
            await ethereum.enable();
        }
        let accountsOnEnable = await ethereum.request({method: 'eth_requestAccounts'});
        console.log('accountsOnEnable', accountsOnEnable);
        window.account = accountsOnEnable[0];

        let x = document.getElementById("account");
        if (x.style.display === "none") {
            x.style.display = "block";
            let connect = document.getElementById("connect");
            connect.style.display = "block";
            x.innerText = "Account: " + accountsOnEnable[0]
        } else {
            x.style.display = "none";

        }

    }

    document.getElementById("connect").addEventListener("click", connectMetamask);


    async function sign() {
        let message = document.getElementById("message").value;
        let nonce = document.getElementById("nonce").value;
        let msg = message + ":" + nonce;
        msg = window.web3.utils.sha3(msg);
        console.log("message", msg);
        document.getElementById("message_signed").innerText = msg;
        let signature = window.web3.eth.personal.sign(msg, window.account).then(data => {
            console.log("signture", data)

            var div = document.getElementById('signature');

            div.innerHTML += data;
        });
    }

    document.getElementById("sign").addEventListener("click", sign);

    async function getResult() {
            console.log("@@@@@@@@: OK ");
            if (typeof web3 !== 'undefined') {
                web3 = new Web3(web3.currentProvider);
            } else {
                web3 = new Web3(new Web3.providers.HttpProvider('http://localhost:8545'));
            }
            if (window.ethereum) {
                await ethereum.enable();
            }
            let accountsOnEnable = await ethereum.request({ method: 'eth_requestAccounts' });
            let contractGiaiThua = getContractInstance(Config.nftAbi, Config.nftAddress);
            console.log(contractGiaiThua);
            let value = document.getElementById("input-number").value;
            console.log("@@@@@@@@: OK2");
            GiaiThua(contractGiaiThua, value).then(data => {
                console.log("@@@@@@@@: OK3");
                document.getElementById("show").innerText = data;
                console.log("@@@@@@@@: "+ data);
            });
        }
        document.getElementById("btn-check").addEventListener("click", getResult);
        
    
</script>
</html>